#!/usr/bin/env bash
set -e

CACHEDIR=$2
NGINX_COMMON=nginx-common_1.2.1-2.2ubuntu0.2_all.deb
NGINX_FULL=nginx-full_1.2.1-2.2ubuntu0.2_amd64.deb
NGINX=nginx_1.2.1-2.2ubuntu0.2_all.deb

if [[ ! -f "$CACHEDIR/$NGINX" ]]; then
  apt-get update
  apt-get download nginx nginx-common nginx-full
  mv nginx* $CACHEDIR/
fi

dpkg -i $CACHEDIR/$NGINX_COMMON
dpkg -i $CACHEDIR/$NGINX_FULL
dpkg -i $CACHEDIR/$NGINX

BINDIR=$(dirname "$0")

if [[ ! -f $1/nginx.conf.erb ]]; then
    cp $BINDIR/../conf/nginx.conf.erb $1/nginx.conf.erb
fi

if [[ ! -f $1/mime.types ]]; then
	cp $BINDIR/../conf/mime.types $1/mime.types
fi

if [[ -e $1/${CUSTOM_BUILD:-custom-build} ]]; then
    $1/${CUSTOM_BUILD:-custom-build} "$@"
fi
